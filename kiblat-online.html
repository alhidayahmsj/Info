<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kompas Kiblat Online</title>
<style>
  body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;font-family:sans-serif;background:#f7f7f7;color:#111}
  .card{width:320px;max-width:95vw;padding:18px;border-radius:12px;background:#fff;box-shadow:0 8px 24px rgba(0,0,0,.1);text-align:center}
  h1{margin:.2rem 0 .6rem;font-size:1.1rem}
  #compass{width:240px;height:240px;margin:10px auto;position:relative;border-radius:50%;border:6px solid #e5e7eb;display:flex;align-items:center;justify-content:center;background:#fafafa}
  .north{position:absolute;top:10px;left:50%;transform:translateX(-50%);font-weight:600}
  .arrow{width:0;height:0;border-left:20px solid transparent;border-right:20px solid transparent;border-bottom:70px solid #1a73e8;transform-origin:50% 90%;transition:transform .15s linear}
  .info{margin-top:.6rem;font-size:.95rem}
  .small{font-size:.8rem;color:#666;margin-top:6px}
  button{margin-top:12px;padding:8px 14px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .warn{color:#b03;font-size:.85rem;margin-top:6px}
</style>
</head>
<body>
  <div class="card">
    <h1>Penunjuk Arah Kiblat</h1>

    <div id="compass">
      <div class="north">N</div>
      <div class="arrow" id="arrow"></div>
    </div>

    <div class="info">
      <div><b id="degText">—</b>° dari utara</div>
      <div class="small" id="distanceText">Menunggu lokasi…</div>
      <div class="warn" id="status"></div>
    </div>

    <button id="retry">Minta Lokasi & Orientasi</button>
    <div class="small">Izinkan akses lokasi & sensor agar panah akurat.</div>
  </div>

<script>
(function(){
  const KAABA = {lat:21.4225, lon:39.8262}; // Koordinat Ka'bah
  const arrow = document.getElementById('arrow');
  const degText = document.getElementById('degText');
  const distanceText = document.getElementById('distanceText');
  const status = document.getElementById('status');
  const retryBtn = document.getElementById('retry');

  let bearingToKaaba = null;
  let deviceHeading = null;
  let userPos = null;

  function toRad(d){return d*Math.PI/180;}
  function toDeg(r){return r*180/Math.PI;}

  function computeBearing(lat1, lon1, lat2, lon2){
    const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
    const y=Math.sin(Δλ)*Math.cos(φ2);
    const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    return (toDeg(Math.atan2(y,x))+360)%360;
  }

  function computeDistanceKM(lat1, lon1, lat2, lon2){
    const R=6371;
    const φ1=toRad(lat1), φ2=toRad(lat2);
    const Δφ=toRad(lat2-lat1), Δλ=toRad(lon2-lon1);
    const a=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  }

  function updateUI(){
    if(bearingToKaaba==null) return;
    degText.textContent=Math.round(bearingToKaaba);
    if(userPos){
      const km=computeDistanceKM(userPos.latitude,userPos.longitude,KAABA.lat,KAABA.lon);
      distanceText.textContent=Math.round(km).toLocaleString()+" km ke Ka'bah";
    }
    let rotateDeg=bearingToKaaba;
    if(deviceHeading!=null){
      rotateDeg=(bearingToKaaba-deviceHeading+360)%360;
    }else{
      status.textContent="Orientasi tidak tersedia, gunakan arah utara sebagai acuan.";
    }
    arrow.style.transform=`rotate(${rotateDeg}deg)`;
  }

  function gotPosition(pos){
    userPos=pos.coords;
    bearingToKaaba=computeBearing(userPos.latitude,userPos.longitude,KAABA.lat,KAABA.lon);
    status.textContent="";
    updateUI();
  }

  function posError(err){
    status.textContent="Lokasi gagal: "+(err.message||err.code);
    distanceText.textContent="Tidak ada info jarak.";
  }

  function requestLocation(){
    if(!navigator.geolocation){status.textContent="Browser tidak mendukung Geolocation.";return;}
    status.textContent="Mencari lokasi…";
    navigator.geolocation.getCurrentPosition(gotPosition,posError,{enableHighAccuracy:true,timeout:15000});
  }

  function handleOrientationEvent(e){
    let heading=null;
    if(typeof e.webkitCompassHeading==="number"){heading=e.webkitCompassHeading;}
    else if(e.alpha!=null){heading=e.alpha;}
    if(heading!=null){
      deviceHeading=(360-heading+360)%360;
      status.textContent="";
      updateUI();
    }
  }

  async function enableOrientation(){
    if(typeof DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function"){
      try{
        const resp=await DeviceOrientationEvent.requestPermission();
        if(resp==="granted"){window.addEventListener("deviceorientation",handleOrientationEvent,true);}
        else{status.textContent="Akses orientasi ditolak.";}
      }catch(err){status.textContent="Error orientasi: "+err;}
    }else if(window.DeviceOrientationEvent){
      window.addEventListener("deviceorientation",handleOrientationEvent,true);
    }else{
      status.textContent="Perangkat tidak mendukung orientasi.";
    }
  }

  retryBtn.addEventListener("click",()=>{requestLocation();enableOrientation();});
  requestLocation();
  enableOrientation();
})();
</script>
</body>
</html>